<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/headFragment}"></head>

<body>

<div th:replace="~{fragments/headerFragment}"></div>

<br/><br/>
<div class="container">
    <h2>Задачи</h2>
    <!-- Используем форму для отправки выбора категории на сервер -->
    <form id="categoryForm">
        <label for="categorySelect" class="form-label">Выберите категорию:</label>
        <select id="categorySelect" name="categoryId" class="form-select" onchange="loadTasks()">
            <!-- Используем th:each для обработки категорий -->
            <option th:each="category, iterStat : ${categories}"
                    th:value="${category.id}"
                    th:text="${category.name}"
                    th:selected="${iterStat.index == 0}"></option>
        </select>
    </form>

    <a th:href="@{/admin/tasks/new}" class="btn btn-primary mt-2">Добавить новую задачу</a>

    <div id="tasksTableBody">
    <!-- Сюда будут добавляться строки с задачами -->
    </div>

</div>
<script th:inline="javascript">

    document.addEventListener('DOMContentLoaded', function () {
        loadTasks();
    });

    function loadTasks() {
        // Получаем выбранное значение из селекта
        var categoryId = document.getElementById('categorySelect').value;

        // Отправляем запрос на сервер для загрузки задач через AJAX
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/admin/tasks/category/' + categoryId, true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                // Вставляем полученный HTML в тело таблицы
                document.getElementById('tasksTableBody').innerHTML = xhr.responseText;

                calculateAndDisplayTotalTime();
            }
        };
        xhr.send();
    }

    // function  calculateAndDisplayTotalTime(){
    //     var totalSeconds = 0;
    //     var totalCost = 0.0;
    //
    //     //Используем класс 'timeInSeconds' для выбора всех ячеек со временем
    //     var timeCells = document.getElementsByClassName('timeInSeconds');
    //     var costCells = document.getElementsByClassName('costPerPiece');
    //
    //     //Проходим по всем ячейкам и складываем значения
    //     for(var i = 0; i < timeCells.length; i++){
    //         totalSeconds += parseInt(timeCells[i].textContent);
    //         //Преобразовываем запятые в точки и парсим как float
    //         totalCost += parseFloat(costCells[i].textContent.replace(',', '.'));
    //     }
    //
    //     //Обновляем элемент с итоговым временем
    //     var totalElement = document.getElementById('totalTime');
    //     if(!totalElement){
    //         totalElement = document.createElement('div');
    //         totalElement.id = 'totalTime';
    //
    //        document.querySelector('table tbody').appendChild(totalElement);
    //     }
    //     totalElement.textContent = totalSeconds + ' сек';
    //
    //    //Обновляем элемент с итоговой стоимостью
    //     var  totalCostElement = document.getElementById('totalCost');
    //     if(!totalCostElement){
    //         totalCostElement = document.createElement('td');
    //         totalCostElement.id = 'totalCost';
    //         document.querySelector('table tbody').appendChild(totalCostElement);
    //     }
    //     totalCostElement.textContent = totalCost.toFixed(2).replace('.', ',') + ' руб.';
    // }
</script>

</body>
</html>
